# Chapter 4. Build Lifecycles

* A Maven build lifecycle consist of a set of well-defined phases : 建構的生命週期是由一套Phases組成。

* ~~Each phase groups a set of goals defined by Maven plugins : 每個Phase會聚集由Maven插件所定義的一套goals。~~

* Lifecycle defines the order of execution : Lifecycle定義~~執行~~phases順序。

* Goal is responsible for performing a specific action : Goal負責執行一個特定的工作。

* ~~A Maven plugin is a collection of goals : Maven插件是一個goals集合。~~

The following figure shows the relationship between maven plugin goals and lifecycle phases:

![](image-klsxafxm.png)


### $ mvn clean install 到底做了什麼事?

> 先執行clean lifecycle的phases，直到clean pahse，在執行default phase的phase，直到install phase

## Standard Lifecycles in Maven

* Maven comes with three standard lifecycles : 
    1. default
    2. clean
    3. site

### The clean lifecycles

* The clean lifecycles defines three phases:
    1. pre-clean
    2. clean
    3. post-clean

* ~~A phase in a lifecycle is just an ordered placeholder in the build execution path :~~ 
    1. ~~Phase在建構執行路徑中，就只是一個有序的placeholder~~
    2. ~~例如在clean lifecycle裡的clean phase是不做任何事情的。~~

> phases不做任何動作，綁定在phases上的goals才是真正執行動作的

* In the Maven architecture, it has two key elements(關鍵要素):
    1. nonus
    2. verbs

* Both nouns and verbs, which are related to a given project, are defined in the POM file : 
    1. 與特定的project相關
    2. 被定義在POM裡

* nouns包含 :
    1. the name of the project
    2. the name of the parent project
    3. the dependencies
    4. the type of the packaging

* Plugins bring verbs into the Maven build system

~~* Plugins defines what need to be done during the build execution via its goals~~

> Goals 可以自己獨自執行，但也可以登記到特定的phase。

### **$ mvn clean**

> 執行clean pahse
>
> clean是指clean phase，不是指clean lifecycle
>
> 意思是執行clean lifecycle的phases，直到clean phase
>
> 第一步驟，會清空working directory(預設是target directory)；此動作是透過maven clean plugin。

* In Maven, you cannot simply execute a lifecycle by its name, it has to be the name of phase

* Maven will find the corresponding lifecycle and will execute it up to the given phase(including that pahse)

### **$ mvn help:describe -Dplugin=clean**

> help:describe : 指help插件的describe goal 

### **$ mvn clean:clean**

> 執行clean插件的clean goal
>
> 第一個clean是clean plugin，第二個clean是clean goal

The following figure shows the relationship between the Maven clean plugin goals and the clean lifecycle phases

![](image-klt4lffz.png)

* ~~The clean goal of the clean plugin is configured by default to get executed during the clean phase~~

* ~~The plugin goal to the lifecycle phase mapping can be provided through the application POM file. If not, it will be inherited from super POM file~~

* ~~The super POM file, which defines clean plugin by default, adds the plugin to the clean phase of the clean lifecycle~~

> 在super POM file中，會定義clean plugin並把plugin加到clean lifecycle的clean phase
>
> 但clean goal怎麼加到clean phase?

> You cannot define same phase in two different lifecycles

The following code snippet shows how the clean goal of the clean plugin is assciated with the clean phase of the clean lifecycle

![](image-klt7puvj.png)
![](image-klt7r3mh.png)

* pre-clean & post-clean phases do not have any pling bindings

* The objective of the pre-clean phase is to perform any operations prior to the cleaning task

* The objective of the post-clean phase is to perform any operatons after the cleaning task

### The default lifecycles

* The default lifecycle in Maven defines 23 phases

### **$ mvn clean install**

> 先執行clean phase，在執行install phase
>
> 精確的意思是先執行clean lifecycle的phases，直到clean phase，在執行default lifecycle的phases，直到install phase

* The phases in the default lifecycle do not have any associated plugin goals

* The plugin bindings for each phase are defined by the corresponding packaging

> 不同的打包類型會有不同的plugin，所以事先確定是哪種打包類型，才會決定哪些plugins會binding到phase


* default lifecycle的23個phases說明，以及執行順序
    1. validate : validate POM file and necessary information is available
    2. initialize : 藉由配置正確目錄結構和初始化properties來初始化建構
    3. generate-sources : generates any required source code
    4. process-sources : processes the generated source code
    5. generate-resources : generate any resources that need to be packaged with the final artifact
    6. process-resources : processes the generated resources，複製到特定目錄並準備被打包
    7. compile : compiles the source code
    8. process-classes : can be used to carry out any bytecode enhancements after the compile phase
    9. generate-test-sources : generates any required source code for test
    10. process-test-sources : processes the generated source test code
    11. generate-test-resources : generates all the resources required to run test 
    12. process-test-resources : processes the generated test resources，複製到特定目錄並準備進行測試
    13. test-compile : compiles the source code for test
    14. process-test-classes : can be used to carry out any bytecode enhancements after the test-compile phase
    15. test : 使用適當的unit test framework執行測試
    16. prepare-package : 整理要打包的artifacts
    17. package : 將artifacts打包成發佈格式，如jar、war
    18. pre-integration-test : performs any required action before runnning integration tests
    19. integration-test : runs integration tests
    20. post-integration-test : be used to performs any cleanup tasks after running the integration tests
    21. verify : 驗證package的有效性(validity)。檢查有效性的規則必須藉由respective plugins定義
    22. install : installs the final artifact in the local repository 
    23. deploy : deploys the final artifact to a remote reository


> package type設定在pom.xml的<package>，若省略，預設為jar

### $ mvn help:describe -Dcmd=deploy

> 不同的packaging type會有不同的relationship between plugin:goal and lifecycle phases，可用此cmd來查看詳細的goal to phase mapping

### The site lifecycle

* The site lifecycle has four phases:
    1. pre-site
    2. site
    3. post-site
    4. site-deploy
    
* The site plugin is used to generate static HTML content for a project. The generated HTML content will also include appropriate reports corresponding to the project    

## Lifecycle bindings

* The standard Maven lifecycles and their associated bindings are defined under the file META-INF/plexus/components.xml of MAVEN_HOME/lib/maven-core-3.6.3.har
  
* components.xml : component descriptor，描述被Maven使用來管理project lifecycle的properties
  

![](image-klubbl4m.png)
![](image-klubcse2.png)    
    
> &lt;role> : component type is Lifecycle, component java interface
>
> &lt;implementation> : 實作的具體class
>
> &lt;role-hint> : 與&lt;role>組合成component的身分
>
> &lt;configuration>&lt;id> : Lifecycle的名稱
>
> &lt;configuration>&lt;phase> : Lifecycle的phase，順序就是執行順序 

![](image-klubnzbl.png)    
    
> &lt;configuration>&lt;default-phases>&lt;clean> : binding clean lifecycle的clean phase與內文clean plugin的clean goal

![](image-klubu48b.png)
![](image-klubuxe5.png)
    
> &lt;role> : component type is LifecycleMapping, component java interface
>
> &lt;configuration>&lt;lifecycles>&lt;lifecycle&lt;id> : Lifecycle的名稱
>
> &lt;configuration>&lt;lifecycles>&lt;lifecycle&lt;phases> : Lifecycle的phase與plugin的goal的binding    

## Building custom lifecycles

* custom lifecycle有2種方式
    1. 對已存在的lifecycle，增加新的goals to phases mapping
    2. 定義全新的lifecycle
    
> The Maven architecture is based on the Inversion of Control(IoC) architectural principal
>
> Maven uses Plexus as its IoC container. 
>
> Plexus is similar to other IoC container or dependency injection framework such as Spring.
>
> The components.xml file in Maven is the heart of the Plexus framework


## Lifecycle extensions